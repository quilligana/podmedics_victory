function set_comment_form_target(message, commentable_type, commentable_id)
{
	$(".comments_textarea").val("");
    $("#comment_commentable_type").val(commentable_type);
    $("#comment_commentable_id").val(commentable_id);
}

function create_dom_element(element_string)
{
	var div = document.createElement('div');
	div.innerHTML = element_string;
	return div
}

// Show the element over 400 milliseconds after a 500 millisecond delay.
// This gives the tab_container to expand before inserting the new element.
function show(element)
{
	setTimeout(function () { $(element).fadeIn(400)},500);
  	setTimeout(function () { $(comment).removeClass('new_comment_active_state');}, 2000);
}

// Show the element over 400 milliseconds after a 500 millisecond delay.
// This gives the tab_container to contract before hiding the element.
function hide(element)
{
	setTimeout(function(){$(element).fadeOut(400)},500);
}

// Show the element over 400 milliseconds after a 500 millisecond delay.
// This gives the tab_container to contract before removing the element.
function remove(element)
{
	hide($(element));
	setTimeout(function(){$(element).remove()},900);
}

function go_to(element)
{
	$('html, body').animate({
        scrollTop: $(element).offset().top - 2 + 'px'
    }, 'fast');
}

var tab_container = $("#tabs_container");
var height;

<% if @comment %>
	// Set the comment form to comment on the root again, not the commentable
	set_comment_form_target("", "<%= @comment.root_type %>", <%= @comment.root_id %>);
    $("#reply_cancel_box").hide(100);

    // Update the comments count in the tab title
    <% if @comment.root_type == "Video" %>
    	$(".comments_tab").children()[0].innerHTML = "Comments (<%= @comment.root.comments_count %>)"
    <% else %>
    	$(".comments_tab").children()[0].innerHTML = "<%= @comment.root.comments_count %> Answers"
    <% end %>

    // Create the comment element
	var comment = create_dom_element("<%= escape_javascript render partial: 'comment', object: @comment %>");

	<% if @comment.commentable.class.name == 'Comment' %>
		var comment = comment.getElementsByClassName("comment_reply")[0];
		<% if @comment.commentable.commentable.class.name == 'Comment' %>	
		var comment_container = $(".comment_reply#<%=@comment.commentable.id%>")[0];
		<% else %>
		var comment_container = $(".comment#<%=@comment.commentable.id%>")[0];
		<% end %>
		$(comment).insertAfter($(comment_container));

		// Now let's scroll to the newly created comment.
		setTimeout(function()
		{
			go_to($(comment_container))
		}, 900);
	// Otherwise, .appendChild it to the entire comment div.
	<% else %>
		var comment = comment.getElementsByClassName("comment")[0];
		var comment_container = $(".question_comments_outer")[0];
		comment_container.insertBefore(comment, comment_container.firstChild);

		// Now let's scroll to the newly created comment.
		setTimeout(function()
		{
			go_to($(comment))
		}, 900);
	<% end %>
	// Hide the comment so it can be shown after resizing the tab_container.
	$(comment).hide().addClass('new_comment_active_state');

	// Make sure the "No comments" message is gone.
	var no_comments_div = $(".no_questions_reply_wrapper")[0];
	var no_comments_message_height = $(no_comments_div).outerHeight(true);

	// Store new height of tab_container.
	height =	tab_container.height() + 
				$(comment).outerHeight(true) - 
				$(no_comments_div).outerHeight(true);
<% else %>
	// Create error notification
	var notification = create_dom_element("<%= escape_javascript render 'comments/error_notification' %>");

	// Insert the notification at the top of the tab_container
	var notification_container = $("#tabs-2")[0];
	$(notification).hide();
	notification_container.insertBefore(notification, notification_container.firstChild);
	var notification_wrapper = $(notification).children()[0];
	var notification_inner = $(notification_wrapper).children()[0];
	var notification_height = $(notification_inner).outerHeight(true);

	// Add height of notification to new tab_container height.
	height += notification_height;

	show($(notification));
<% end %>


// Apply the height change to the tab_container.
tab_container.height(height);

// Show/Hide appropriate elements.
remove($(no_comments_div));
show($(comment));